<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Onigiri Catcher</title>
  <!-- p5.js ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      margin: 0;
      overflow: hidden;
      touch-action: none;
      overscroll-behavior: none;
      background: #888; /* ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤æ™‚ã¯ã‚°ãƒ¬ãƒ¼ */
      font-family: sans-serif;
    }
    /* p5.js ãŒç”Ÿæˆã™ã‚‹ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯ç”»é¢å…¨ä½“ã«è¡¨ç¤º */
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    /* ç”»é¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 350px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }
    .hidden {
      display: none;
    }
    .button {
      font-size: 18px;
      padding: 10px 20px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    .button:hover {
      background-color: #ddd;
    }
    /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆæ¨ªä¸¦ã³ï¼‰ */
    .score-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="startScreen" class="screen">
    <h3>ï¼”ï¼—å¸‚ -ãƒ¨ãƒ³ãƒŠãƒŠã‚¤ãƒ- presents</h3>
    <h1>Onigiri Catcher</h1>
    <p>ãŠã«ãã‚Šã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦<br>é£²ã¿ç‰©ã‚’é¿ã‘ã‚ï¼</p>
    <button class="button" onclick="startGame()">Game Start</button>
    <p style="font-size: 14px; color: #777;">â€» Safariã€Chromeæ¨å¥¨</p>
  </div>
  
  <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
  <div id="gameOverScreen" class="screen hidden">
    <h2>Game Over!</h2>
    <div class="score-container">
      <p>ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
      <p>ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highScore">0</span></p>
    </div>
    <img id="gameOverImage" src="" alt="Game Over Image" style="width: 80%; max-width: 300px; margin: 0 auto; display: none; cursor: pointer;">
    <p id="countdownTimer" style="font-size: 16px; margin-top: 10px;"></p>
    <button class="button hidden" id="playAgainButton" onclick="restartGame()">Play Again</button>
    <button class="button hidden" id="instagramButton" onclick="window.open('https://www.instagram.com/47markets/', '_blank')">ï¼”ï¼—å¸‚ãƒœã‚¿ãƒ³</button>
    <button class="button hidden" id="giftButton" onclick="window.open('https://shop.47markets.org/', '_blank')">ï¼”ï¼—å¸‚ã‚®ãƒ•ãƒˆãƒœã‚¿ãƒ³</button>
  </div>
  
  <!-- BGM -->
  <audio id="bgm" loop>
    <source src="bgm.mp3" type="audio/mpeg">
  </audio>
  
  <script>
    /***************************************
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
     ***************************************/
    let player;
    let onigiri;
    let teaList = [];
    let sakeList = [];
    let score = 0;
    let highScore = 0;
    let gameStarted = false;
    let gameOver = false;
    let teaSpeed = 5;
    let canvas;
    
    /***************************************
     * ã‚¯ãƒ©ã‚¹å®šç¾©
     ***************************************/
    // ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ï¼šItemï¼ˆãŠã«ãã‚Šã€èŒ¶ãªã©ã®å…±é€šå‡¦ç†ï¼‰
    class Item {
      constructor(x, y, symbol, speed) {
        this.x = x;
        this.y = y;
        this.symbol = symbol;
        this.speed = speed;
      }
      fall() {
        this.y += this.speed;
        if (this.y > height + 30) {
          this.reset();
        }
      }
      reset() {
        this.x = random(30, width - 30);
        this.y = -30;
      }
      show() {
        textSize(30);
        fill(0);
        text(this.symbol, this.x, this.y);
      }
    }
    
    // ğŸ¶ã‚¯ãƒ©ã‚¹ï¼šSakeï¼ˆå›ºå®šè§’åº¦ã§ãƒã‚¦ãƒ³ãƒ‰ï¼‰
    class Sake extends Item {
      constructor(x, y) {
        // å‚ç›´é€Ÿåº¦ã¯5å›ºå®š
        super(x, y, 'ğŸ¶', 5);
        // 30Â°ï½45Â°ã®è§’åº¦ï¼ˆãƒ©ã‚¸ã‚¢ãƒ³ï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        let angle = random(radians(30), radians(45));
        // æ°´å¹³æ–¹å‘ã®é€Ÿåº¦ = å‚ç›´é€Ÿåº¦ Ã— tan(angle)
        let speedX = this.speed * tan(angle);
        // å·¦å³ã©ã¡ã‚‰ã‹ã«é€²ã‚€ï¼ˆç¬¦å·ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼‰
        this.speedX = random([1, -1]) * speedX;
      }
      fall() {
        this.y += this.speed;
        this.x += this.speedX;
        // æ¨ªç«¯ã«é”ã—ãŸã‚‰ãƒã‚¦ãƒ³ãƒ‰
        if (this.x < 0 || this.x > width - 30) {
          this.speedX *= -1;
        }
        if (this.y > height + 30) {
          this.reset();
        }
      }
    }
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹
    class Player {
      constructor() {
        this.x = width / 2;
        this.y = height - 50; // ä¸‹éƒ¨å›ºå®š
        this.symbol = 'ğŸš›';
      }
      update() {
        // PC: mouseXã€ã‚¹ãƒãƒ›: touches[0].x ã‚’ä½¿ç”¨
        if (touches.length > 0) {
          this.x = constrain(touches[0].x, 0, width - 30);
        } else {
          this.x = constrain(mouseX, 0, width - 30);
        }
      }
      show() {
        textSize(30);
        fill(0);
        text(this.symbol, this.x, this.y);
      }
    }
    
    /***************************************
     * p5.js é–¢æ•°
     ***************************************/
    function setup() {
      canvas = createCanvas(windowWidth * 0.9, windowHeight);
      canvas.style('display', 'block');
      // localStorage ã‹ã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’å–å¾—
      highScore = localStorage.getItem("highScore") ? parseInt(localStorage.getItem("highScore")) : 0;
      player = new Player();
      onigiri = new Item(random(30, width - 30), -30, 'ğŸ™', 5);
      noLoop(); // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ãƒ«ãƒ¼ãƒ—åœæ­¢
    }
    
    // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å¯¾å¿œ
    function windowResized() {
      resizeCanvas(windowWidth * 0.9, windowHeight);
    }
    
    // ãƒ¡ã‚¤ãƒ³ã®ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
    function draw() {
      background(128); // ã‚°ãƒ¬ãƒ¼èƒŒæ™¯
      if (gameStarted && !gameOver) {
        player.update();
        player.show();
        
        onigiri.fall();
        onigiri.show();
        
        for (let tea of teaList) {
          tea.fall();
          tea.show();
        }
        
        for (let sake of sakeList) {
          sake.fall();
          sake.show();
        }
        
        // å·¦ä¸Šã«ã‚¹ã‚³ã‚¢è¡¨ç¤º
        textSize(20);
        fill(255);
        text(`Score: ${score}`, 20, 30);
        
        checkCollisions();
      }
    }
    
    /***************************************
     * ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
     ***************************************/
    // è¡çªåˆ¤å®š
    function checkCollisions() {
      // ãŠã«ãã‚Šã¨ã®è¡çªï¼ˆã‚­ãƒ£ãƒƒãƒæ™‚ï¼‰
      if (dist(player.x, player.y, onigiri.x, onigiri.y) < 30) {
        score++;
        teaSpeed += 0.1;
        onigiri.reset();
        
        // ã‚¹ã‚³ã‚¢ãŒ5ã®å€æ•°ã§ğŸµã‚’è¿½åŠ 
        if (score % 5 === 0) {
          teaList.push(new Item(random(30, width - 30), -30, 'ğŸµ', teaSpeed));
        }
        // ã‚¹ã‚³ã‚¢ãŒ10ã®å€æ•°ã§ğŸ¶ã‚’è¿½åŠ 
        if (score % 10 === 0) {
          sakeList.push(new Sake(random(30, width - 30), -30));
        }
      }
      
      // ğŸµï¼ˆãŠèŒ¶ï¼‰ã¨ã®è¡çªåˆ¤å®š
      for (let tea of teaList) {
        if (dist(player.x, player.y, tea.x, tea.y) < 30) {
          triggerGameOver();
          return;
        }
      }
      // ğŸ¶ï¼ˆé…’ï¼‰ã¨ã®è¡çªåˆ¤å®š
      for (let sake of sakeList) {
        if (dist(player.x, player.y, sake.x, sake.y) < 30) {
          triggerGameOver();
          return;
        }
      }
    }
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®å‡¦ç†
    function triggerGameOver() {
      if (gameOver) return;  // äºŒé‡å®Ÿè¡Œé˜²æ­¢
      gameOver = true;
      noLoop();
      
      const gameOverScreen = document.getElementById("gameOverScreen");
      if (gameOverScreen) {
        gameOverScreen.classList.remove("hidden");
      }
      
      const finalScoreElem = document.getElementById("finalScore");
      if (finalScoreElem) finalScoreElem.textContent = score;
      
      // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      const highScoreElem = document.getElementById("highScore");
      if (highScoreElem) highScoreElem.textContent = highScore;
      
      // 50%ã®ç¢ºç‡ã§è¡¨ç¤ºã™ã‚‹ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»åƒã¨ãƒªãƒ³ã‚¯å…ˆã‚’æ±ºå®š
      const gameOverImage = document.getElementById("gameOverImage");
      let imageURL, imageLink;
      if (random() < 0.5) {
        imageURL = "pr_image1.png";
        imageLink = "https://shop.47markets.org/";
      } else {
        imageURL = "pr_image2.png";
        imageLink = "https://www.instagram.com/47markets/";
      }
      if (gameOverImage) {
        gameOverImage.src = imageURL;
        gameOverImage.style.display = "block";
        // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ãƒªãƒ³ã‚¯ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        gameOverImage.onclick = function() {
          window.open(imageLink, '_blank');
        };
      }
      
      // 4ç§’é–“ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
      const countdownElem = document.getElementById("countdownTimer");
      let countdown = 4;
      if (countdownElem) {
        countdownElem.textContent = `ã‚ã¨ ${countdown} ç§’ã§å†æŒ‘æˆ¦ã§ãã¾ã™`;
        countdownElem.style.display = "block";
      }
      
      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownElem) {
          countdownElem.textContent = `ã‚ã¨ ${countdown} ç§’ã§å†æŒ‘æˆ¦ã§ãã¾ã™`;
        }
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          if (gameOverImage) {
            gameOverImage.style.display = "none";
          }
          if (countdownElem) {
            countdownElem.style.display = "none";
          }
          // 4ç§’å¾Œã«å„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          const playAgainButton = document.getElementById("playAgainButton");
          const instagramButton = document.getElementById("instagramButton");
          const giftButton = document.getElementById("giftButton");
          if (playAgainButton) playAgainButton.classList.remove("hidden");
          if (instagramButton) instagramButton.classList.remove("hidden");
          if (giftButton) giftButton.classList.remove("hidden");
        }
      }, 1000);
    }
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
    function startGame() {
      const startScreen = document.getElementById("startScreen");
      if (startScreen) startScreen.classList.add("hidden");
      const gameOverScreen = document.getElementById("gameOverScreen");
      if (gameOverScreen) gameOverScreen.classList.add("hidden");
      
      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åˆæœŸåŒ–
      score = 0;
      teaSpeed = 5;
      gameOver = false;
      gameStarted = true;
      teaList = [];
      sakeList = [];
      player = new Player();
      onigiri = new Item(random(30, width - 30), -30, 'ğŸ™', 5);
      
      // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«è¡¨ç¤ºã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const playAgainButton = document.getElementById("playAgainButton");
      if (playAgainButton) playAgainButton.classList.add("hidden");
      const instagramButton = document.getElementById("instagramButton");
      if (instagramButton) instagramButton.classList.add("hidden");
      const giftButton = document.getElementById("giftButton");
      if (giftButton) giftButton.classList.add("hidden");
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œå¾Œã«BGMå†ç”Ÿï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾å¿œï¼‰
      const bgm = document.getElementById("bgm");
      if (bgm && bgm.play) {
        bgm.play().catch(error => { console.log("BGM play error:", error); });
      }
      
      loop();
    }
    
    // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†
    function restartGame() {
      const gameOverScreen = document.getElementById("gameOverScreen");
      if (gameOverScreen) gameOverScreen.classList.add("hidden");
      startGame();
    }
  </script>
</body>
</html>
